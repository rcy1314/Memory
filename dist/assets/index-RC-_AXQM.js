var b=(z,d,_)=>new Promise((v,q)=>{var y=m=>{try{e(_.next(m))}catch(f){q(f)}},c=m=>{try{e(_.throw(m))}catch(f){q(f)}},e=m=>m.done?v(m.value):Promise.resolve(m.value).then(y,c);e((_=_.apply(z,d)).next())});import{_ as F}from"./CommonPage-Dj5qqsUj.js";import{_ as k}from"./TheIcon-Mohbq-MB.js";import{d8 as I,r as N,ap as O,o as R,P as T,R as r,az as S,Q as w,_ as n,a0 as s,W as t,X as u,af as U,T as x,F as D,aH as L}from"./index-ON-SflwH.js";import{_ as j}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{a as B,N as E}from"./Divider-CLd23YOQ.js";import{N as A,a as o}from"./FormItem-CFjxQbHB.js";import{N as $}from"./Select-BuVN_q0M.js";import{N as i}from"./Input-Ck59uIzx.js";import{N as h}from"./InputNumber-BfqzlnEt.js";import{N as Q}from"./Switch-D3pB72jH.js";import"./AppPage-wwO3nDER.js";import"./icon-oAdvG0qp.js";import"./Icon-BJkIY_JM.js";import"./format-length-B-p6aW7q.js";import"./use-locale-gdUNdwpT.js";import"./utils-C8CieVbz.js";import"./Popover-DLxopjSP.js";import"./Tag-U0zSNQTP.js";import"./Add-CAjrcp6O.js";const H={class:"flex gap-2"},W={class:"p-4"},X={class:"migration-section"},G={class:"flex justify-center"},J={__name:"index",setup(z){const d=I(),_=N(null),v=N(!1),q=N(!1),y=N(!1),c=[{label:"SQLite",value:"sqlite"},{label:"PostgreSQL",value:"postgresql"},{label:"Neon PostgreSQL",value:"neon"},{label:"MySQL",value:"mysql"}],e=O({database_type:"sqlite",sqlite_path:"./data/db.sqlite3",neon_host:"",neon_port:5432,neon_database:"",neon_username:"",neon_password:"",neon_ssl:!0,mysql_host:"",mysql_port:3306,mysql_database:"",mysql_username:"",mysql_password:"",mysql_ssl:!1,postgresql_host:"",postgresql_port:5432,postgresql_database:"",postgresql_username:"",postgresql_password:"",postgresql_ssl:!1,connection_pool_size:10,connection_timeout:30}),m={database_type:{required:!0,message:"请选择数据库类型",trigger:"change"},sqlite_path:{required:!0,message:"请输入SQLite数据库文件路径",trigger:"blur"},neon_host:{required:!0,message:"请输入Neon数据库主机地址",trigger:"blur"},neon_port:{required:!0,type:"number",message:"请输入有效的端口号",trigger:"blur"},neon_database:{required:!0,message:"请输入数据库名称",trigger:"blur"},neon_username:{required:!0,message:"请输入用户名",trigger:"blur"},neon_password:{required:!0,message:"请输入密码",trigger:"blur"},mysql_host:{required:!0,message:"请输入MySQL主机地址",trigger:"blur"},mysql_port:{required:!0,type:"number",message:"请输入有效的端口号",trigger:"blur"},mysql_database:{required:!0,message:"请输入数据库名称",trigger:"blur"},mysql_username:{required:!0,message:"请输入用户名",trigger:"blur"},mysql_password:{required:!0,message:"请输入密码",trigger:"blur"},postgresql_host:{required:!0,message:"请输入PostgreSQL主机地址",trigger:"blur"},postgresql_port:{required:!0,type:"number",message:"请输入有效的端口号",trigger:"blur"},postgresql_database:{required:!0,message:"请输入数据库名称",trigger:"blur"},postgresql_username:{required:!0,message:"请输入用户名",trigger:"blur"},postgresql_password:{required:!0,message:"请输入用户名",trigger:"blur"},mysql_password:{required:!0,message:"请输入密码",trigger:"blur"},connection_pool_size:{required:!0,type:"number",message:"请输入连接池大小",trigger:"blur"},connection_timeout:{required:!0,type:"number",message:"请输入连接超时时间",trigger:"blur"}},f=p=>{_.value&&_.value.restoreValidation()},C=()=>b(this,null,function*(){try{const p=yield S.getDatabaseSetting();p.data&&Object.assign(e,p.data)}catch(p){console.error("获取数据库设置失败:",p),d.error("获取数据库设置失败")}}),M=()=>b(this,null,function*(){var p;try{yield(p=_.value)==null?void 0:p.validate(),v.value=!0,yield S.updateDatabaseSetting({database:e}),d.success("数据库设置保存成功")}catch(a){console.error("保存数据库设置失败:",a),a.message?d.error(a.message):d.error("保存数据库设置失败")}finally{v.value=!1}}),P=()=>b(this,null,function*(){var p;try{yield(p=_.value)==null?void 0:p.validate(),q.value=!0;const a={db_type:e.database_type==="neon"?"postgresql":e.database_type,db_path:e.database_type==="sqlite"?e.sqlite_path:null,host:e.database_type==="neon"?e.neon_host:e.database_type==="postgresql"?e.postgresql_host:e.database_type==="mysql"?e.mysql_host:null,port:e.database_type==="neon"?e.neon_port:e.database_type==="postgresql"?e.postgresql_port:e.database_type==="mysql"?e.mysql_port:null,database:e.database_type==="neon"?e.neon_database:e.database_type==="postgresql"?e.postgresql_database:e.database_type==="mysql"?e.mysql_database:null,username:e.database_type==="neon"?e.neon_username:e.database_type==="postgresql"?e.postgresql_username:e.database_type==="mysql"?e.mysql_username:null,password:e.database_type==="neon"?e.neon_password:e.database_type==="postgresql"?e.postgresql_password:e.database_type==="mysql"?e.mysql_password:null,ssl:e.database_type==="neon"?e.neon_ssl:e.database_type==="postgresql"?e.postgresql_ssl:e.database_type==="mysql"?e.mysql_ssl:!1};yield S.testDatabaseConnection(a),d.success("数据库连接测试成功")}catch(a){console.error("数据库连接测试失败:",a),a.message?d.error(a.message):d.error("数据库连接测试失败")}finally{q.value=!1}}),V=()=>b(this,null,function*(){var p,a,l;try{yield(p=_.value)==null?void 0:p.validate(),y.value=!0;const g={target_db_type:e.database_type==="neon"?"postgresql":e.database_type,target_db_path:e.database_type==="sqlite"?e.sqlite_path:null,target_host:e.database_type==="neon"?e.neon_host:e.database_type==="postgresql"?e.postgresql_host:e.database_type==="mysql"?e.mysql_host:null,target_port:e.database_type==="neon"?e.neon_port:e.database_type==="postgresql"?e.postgresql_port:e.database_type==="mysql"?e.mysql_port:null,target_database:e.database_type==="neon"?e.neon_database:e.database_type==="postgresql"?e.postgresql_database:e.database_type==="mysql"?e.mysql_database:null,target_username:e.database_type==="neon"?e.neon_username:e.database_type==="postgresql"?e.postgresql_username:e.database_type==="mysql"?e.mysql_username:null,target_password:e.database_type==="neon"?e.neon_password:e.database_type==="postgresql"?e.postgresql_password:e.database_type==="mysql"?e.mysql_password:null,target_ssl:e.database_type==="neon"?e.neon_ssl:e.database_type==="mysql"?e.mysql_ssl||!1:e.database_type==="postgresql"&&e.postgresql_ssl||!1};yield S.migrateDatabaseData(g),d.success("数据迁移成功，数据库配置已自动更新"),yield C(),y.value=!1}catch(g){console.error("数据迁移失败:",g),g.code==="ECONNABORTED"||((a=g.message)==null?void 0:a.includes("timeout"))||((l=g.message)==null?void 0:l.includes("time out"))?d.warning("数据过多，请继续等待迁移完成",{duration:5e3}):(y.value=!1,g.message?d.error(g.message):d.error("数据迁移失败"))}});return R(()=>b(this,null,function*(){yield C()})),(p,a)=>(w(),T(F,{"show-footer":"",title:"数据库设置"},{action:r(()=>[n("div",H,[s(t(L),{type:"primary",loading:q.value,onClick:P},{default:r(()=>[s(k,{icon:"mdi:database-check",size:18,class:"mr-1"}),a[22]||(a[22]=u(" 测试连接 "))]),_:1},8,["loading"]),s(t(L),{type:"primary",loading:v.value,onClick:M},{default:r(()=>[s(k,{icon:"mdi:content-save",size:18,class:"mr-1"}),a[23]||(a[23]=u(" 保存设置 "))]),_:1},8,["loading"])])]),default:r(()=>[n("div",W,[s(t(B),{type:"info",class:"mb-4"},{header:r(()=>a[24]||(a[24]=[u("使用说明")])),default:r(()=>[a[25]||(a[25]=n("ul",{class:"info-list"},[n("li",null,[u("• "),n("strong",null,"测试连接"),u("：仅验证数据库连接是否正常，不会切换当前使用的数据库")]),n("li",null,[u("• "),n("strong",null,"保存设置"),u("：保存数据库配置并立即切换到新数据库（请谨慎操作）")]),n("li",null,[u("• "),n("strong",null,"迁移数据"),u("：将当前数据库的数据迁移到目标数据库，并自动切换配置")])],-1))]),_:1}),s(t(A),{ref_key:"formRef",ref:_,model:e,rules:m,"label-placement":"left","label-width":"120px"},{default:r(()=>[s(t(o),{label:"数据库类型",path:"database_type"},{default:r(()=>[s(t($),{value:e.database_type,"onUpdate:value":[a[0]||(a[0]=l=>e.database_type=l),f],options:c,placeholder:"请选择数据库类型"},null,8,["value"])]),_:1}),e.database_type==="sqlite"?(w(),T(t(o),{key:0,label:"数据库文件路径",path:"sqlite_path"},{default:r(()=>[s(t(i),{value:e.sqlite_path,"onUpdate:value":a[1]||(a[1]=l=>e.sqlite_path=l),placeholder:"请输入SQLite数据库文件路径"},null,8,["value"])]),_:1})):U("",!0),e.database_type==="neon"?(w(),x(D,{key:1},[s(t(o),{label:"主机地址",path:"neon_host"},{default:r(()=>[s(t(i),{value:e.neon_host,"onUpdate:value":a[2]||(a[2]=l=>e.neon_host=l),placeholder:"请输入Neon数据库主机地址"},null,8,["value"])]),_:1}),s(t(o),{label:"端口",path:"neon_port"},{default:r(()=>[s(t(h),{value:e.neon_port,"onUpdate:value":a[3]||(a[3]=l=>e.neon_port=l),placeholder:"请输入端口号",min:1,max:65535},null,8,["value"])]),_:1}),s(t(o),{label:"数据库名",path:"neon_database"},{default:r(()=>[s(t(i),{value:e.neon_database,"onUpdate:value":a[4]||(a[4]=l=>e.neon_database=l),placeholder:"请输入数据库名称"},null,8,["value"])]),_:1}),s(t(o),{label:"用户名",path:"neon_username"},{default:r(()=>[s(t(i),{value:e.neon_username,"onUpdate:value":a[5]||(a[5]=l=>e.neon_username=l),placeholder:"请输入用户名"},null,8,["value"])]),_:1}),s(t(o),{label:"密码",path:"neon_password"},{default:r(()=>[s(t(i),{value:e.neon_password,"onUpdate:value":a[6]||(a[6]=l=>e.neon_password=l),type:"password",placeholder:"请输入密码","show-password-on":"click"},null,8,["value"])]),_:1}),s(t(o),{label:"启用SSL",path:"neon_ssl"},{default:r(()=>[s(t(Q),{value:e.neon_ssl,"onUpdate:value":a[7]||(a[7]=l=>e.neon_ssl=l)},null,8,["value"])]),_:1})],64)):U("",!0),e.database_type==="postgresql"?(w(),x(D,{key:2},[s(t(o),{label:"主机地址",path:"postgresql_host"},{default:r(()=>[s(t(i),{value:e.postgresql_host,"onUpdate:value":a[8]||(a[8]=l=>e.postgresql_host=l),placeholder:"请输入PostgreSQL主机地址"},null,8,["value"])]),_:1}),s(t(o),{label:"端口",path:"postgresql_port"},{default:r(()=>[s(t(h),{value:e.postgresql_port,"onUpdate:value":a[9]||(a[9]=l=>e.postgresql_port=l),placeholder:"请输入端口号",min:1,max:65535},null,8,["value"])]),_:1}),s(t(o),{label:"数据库名",path:"postgresql_database"},{default:r(()=>[s(t(i),{value:e.postgresql_database,"onUpdate:value":a[10]||(a[10]=l=>e.postgresql_database=l),placeholder:"请输入数据库名称"},null,8,["value"])]),_:1}),s(t(o),{label:"用户名",path:"postgresql_username"},{default:r(()=>[s(t(i),{value:e.postgresql_username,"onUpdate:value":a[11]||(a[11]=l=>e.postgresql_username=l),placeholder:"请输入用户名"},null,8,["value"])]),_:1}),s(t(o),{label:"密码",path:"postgresql_password"},{default:r(()=>[s(t(i),{value:e.postgresql_password,"onUpdate:value":a[12]||(a[12]=l=>e.postgresql_password=l),type:"password",placeholder:"请输入密码","show-password-on":"click"},null,8,["value"])]),_:1}),s(t(o),{label:"启用SSL",path:"postgresql_ssl"},{default:r(()=>[s(t(Q),{value:e.postgresql_ssl,"onUpdate:value":a[13]||(a[13]=l=>e.postgresql_ssl=l)},null,8,["value"])]),_:1})],64)):U("",!0),e.database_type==="mysql"?(w(),x(D,{key:3},[s(t(o),{label:"主机地址",path:"mysql_host"},{default:r(()=>[s(t(i),{value:e.mysql_host,"onUpdate:value":a[14]||(a[14]=l=>e.mysql_host=l),placeholder:"请输入MySQL主机地址"},null,8,["value"])]),_:1}),s(t(o),{label:"端口",path:"mysql_port"},{default:r(()=>[s(t(h),{value:e.mysql_port,"onUpdate:value":a[15]||(a[15]=l=>e.mysql_port=l),placeholder:"请输入端口号",min:1,max:65535},null,8,["value"])]),_:1}),s(t(o),{label:"数据库名",path:"mysql_database"},{default:r(()=>[s(t(i),{value:e.mysql_database,"onUpdate:value":a[16]||(a[16]=l=>e.mysql_database=l),placeholder:"请输入数据库名称"},null,8,["value"])]),_:1}),s(t(o),{label:"用户名",path:"mysql_username"},{default:r(()=>[s(t(i),{value:e.mysql_username,"onUpdate:value":a[17]||(a[17]=l=>e.mysql_username=l),placeholder:"请输入用户名"},null,8,["value"])]),_:1}),s(t(o),{label:"密码",path:"mysql_password"},{default:r(()=>[s(t(i),{value:e.mysql_password,"onUpdate:value":a[18]||(a[18]=l=>e.mysql_password=l),type:"password",placeholder:"请输入密码","show-password-on":"click"},null,8,["value"])]),_:1}),s(t(o),{label:"启用SSL",path:"mysql_ssl"},{default:r(()=>[s(t(Q),{value:e.mysql_ssl,"onUpdate:value":a[19]||(a[19]=l=>e.mysql_ssl=l)},null,8,["value"])]),_:1})],64)):U("",!0),s(t(E),{"title-placement":"left"},{default:r(()=>a[26]||(a[26]=[u("连接池设置")])),_:1}),s(t(o),{label:"连接池大小",path:"connection_pool_size"},{default:r(()=>[s(t(h),{value:e.connection_pool_size,"onUpdate:value":a[20]||(a[20]=l=>e.connection_pool_size=l),placeholder:"请输入连接池大小",min:1,max:100},null,8,["value"])]),_:1}),s(t(o),{label:"连接超时(秒)",path:"connection_timeout"},{default:r(()=>[s(t(h),{value:e.connection_timeout,"onUpdate:value":a[21]||(a[21]=l=>e.connection_timeout=l),placeholder:"请输入连接超时时间",min:1,max:300},null,8,["value"])]),_:1})]),_:1},8,["model"]),s(t(E),{"title-placement":"left"},{default:r(()=>a[27]||(a[27]=[u("数据迁移")])),_:1}),n("div",X,[s(t(B),{type:"warning",class:"mb-4"},{header:r(()=>a[28]||(a[28]=[u("重要提醒")])),default:r(()=>[a[29]||(a[29]=u(" 数据迁移功能将把当前数据库的数据迁移到上述配置的目标数据库中。请确保： ")),a[30]||(a[30]=n("ul",{class:"mt-2 ml-4"},[n("li",null,"• 目标数据库连接信息正确"),n("li",null,"• 目标数据库为空或可以被覆盖"),n("li",null,"• 迁移过程中请勿关闭浏览器"),n("li",null,"• 迁移完成后系统将自动重启并切换到新数据库")],-1))]),_:1}),n("div",G,[s(t(L),{type:"warning",loading:y.value,onClick:V,size:"large"},{default:r(()=>[s(k,{icon:"mdi:database-arrow-right",size:18,class:"mr-1"}),a[31]||(a[31]=u(" 开始迁移数据 "))]),_:1},8,["loading"])])])])]),_:1}))}},ve=j(J,[["__scopeId","data-v-9335e704"]]);export{ve as default};
