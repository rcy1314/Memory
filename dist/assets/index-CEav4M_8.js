var m=(z,c,u)=>new Promise((n,b)=>{var _=a=>{try{f(u.next(a))}catch(w){b(w)}},y=a=>{try{f(u.throw(a))}catch(w){b(w)}},f=a=>a.done?n(a.value):Promise.resolve(a.value).then(_,y);f((u=u.apply(z,c)).next())});import{a1 as V,d8 as A,a5 as G,r as k,j as H,o as Q,P as W,R as i,Q as U,_ as v,a0 as l,W as t,T as B,X as d,F as C,aH as N,Z as X,az as R}from"./index-CWFJs7gC.js";import{_ as Z}from"./CommonPage-D3urqxip.js";import{N as q,a as F}from"./RadioGroup-r_qFLbQY.js";import{N as L,a as D}from"./Divider-CtTDgk7R.js";import{N as J,a as r}from"./FormItem-C8gpvBZ1.js";import{N as K}from"./Switch-oTMU07FN.js";import{N as h}from"./Space-clXW8pBo.js";import{N as g}from"./Input-lGLiS13x.js";import{N as O}from"./InputNumber-6iUCKsyE.js";import"./AppPage-Dsgp7csD.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";import"./use-locale-EYmsExNA.js";import"./format-length-B-p6aW7q.js";import"./Add-BF1x3bEh.js";const Y={class:"m-30 flex items-center"},fe={__name:"index",setup(z){const{t:c}=V(),u=A(),n=G(),b=k(!1),_=k(!1),y=k(!1),f=k(null),a=k({storage_type:"local",enable_storage:!1,max_size:0,timeout_time:0,endpoint:"",region:"",access_id:"",secret_key:"",bucket:"",path:"",prefix:"",suffix:"",local_path:"images",local_prefix:""});function w(){Object.assign(a.value,{storage_type:n.storageSetting.storage_type||"local",enable_storage:n.storageSetting.enable_storage||!1,max_size:n.storageSetting.max_size||0,timeout_time:n.storageSetting.timeout_time||0,endpoint:n.storageSetting.endpoint||"",region:n.storageSetting.region||"",access_id:n.storageSetting.access_id||"",secret_key:n.storageSetting.secret_key||"",bucket:n.storageSetting.bucket||"",path:n.storageSetting.path||"",prefix:n.storageSetting.prefix||"",suffix:n.storageSetting.suffix||"",local_path:n.storageSetting.local_path||"images",local_prefix:n.storageSetting.local_prefix||""})}const j=H(()=>a.value.storage_type==="local");function I(){return m(this,null,function*(){var o,e;_.value=!0;try{const s=yield R.backupPhotos(),$=new Blob([s.data],{type:"application/zip"}),S=window.URL.createObjectURL($),p=document.createElement("a");p.href=S,p.download=`photos_backup_${new Date().toISOString().slice(0,19).replace(/:/g,"-")}.zip`,document.body.appendChild(p),p.click(),document.body.removeChild(p),window.URL.revokeObjectURL(S),u.success("相册备份下载成功")}catch(s){u.error("备份失败："+(((e=(o=s.response)==null?void 0:o.data)==null?void 0:e.detail)||s.message||"未知错误"))}finally{_.value=!1}})}function E(){return m(this,null,function*(){var o,e;y.value=!0;try{const s=yield R.backupDatabase(),$=new Blob([s.data],{type:"application/octet-stream"}),S=window.URL.createObjectURL($),p=document.createElement("a");p.href=S,p.download=`database_backup_${new Date().toISOString().slice(0,19).replace(/:/g,"-")}.db`,document.body.appendChild(p),p.click(),document.body.removeChild(p),window.URL.revokeObjectURL(S),u.success("数据库备份下载成功")}catch(s){u.error("数据库备份失败："+(((e=(o=s.response)==null?void 0:o.data)==null?void 0:e.detail)||s.message||"未知错误"))}finally{y.value=!1}})}Q(()=>m(this,null,function*(){yield n.getStorageSetting(),console.log("Storage setting loaded:",n.storageSetting),w(),console.log("Storage form data initialized:",a.value)}));function x(o){return m(this,null,function*(){var e;b.value=!0,(e=f.value)==null||e.validate(s=>m(this,null,function*(){if(s){b.value=!1;return}yield R.updateStorageSetting(a.value).then(()=>{n.setStorageSetting(a.value),b.value=!1,o&&u.success(c("common.text.save_success"))}).catch(()=>{b.value=!1})}))})}const M={};function P(o){u.success(o==="local"?"已切换到本地存储":"已切换到云端存储"),n.setStorageSetting({storage_type:o}),x(!1)}function T(o){u.success(c(o?"views.setting.label_enable_storage":"views.setting.label_disable_storage")),n.setStorageSetting({enable_storage:o}),x(!1)}return(o,e)=>(U(),W(Z,{title:o.$t("views.setting.label_storage_setting")},{default:i(()=>[v("div",Y,[l(t(J),{ref_key:"infoFormRef",ref:f,"label-placement":"top","label-align":"left","label-width":"100",model:a.value,rules:M,class:"w-500"},{default:i(()=>[l(t(r),{label:o.$t("views.setting.label_enable_storage"),path:"enable_storage"},{default:i(()=>[l(t(K),{value:a.value.enable_storage,"onUpdate:value":[e[0]||(e[0]=s=>a.value.enable_storage=s),T],clearable:""},null,8,["value"])]),_:1},8,["label"]),l(t(r),{label:"存储类型",path:"storage_type"},{default:i(()=>[l(t(q),{value:a.value.storage_type,"onUpdate:value":[e[1]||(e[1]=s=>a.value.storage_type=s),P]},{default:i(()=>[l(t(h),null,{default:i(()=>[l(t(F),{value:"local"},{default:i(()=>e[15]||(e[15]=[d("本地存储")])),_:1}),l(t(F),{value:"cloud"},{default:i(()=>e[16]||(e[16]=[d("云端存储")])),_:1})]),_:1})]),_:1},8,["value"])]),_:1}),l(t(L)),j.value?(U(),B(C,{key:0},[l(t(r),{label:"本地存储路径",path:"local_path"},{default:i(()=>[l(t(g),{value:a.value.local_path,"onUpdate:value":e[2]||(e[2]=s=>a.value.local_path=s),type:"text",placeholder:"图片存储的相对路径，默认为 images",clearable:""},null,8,["value"])]),_:1}),l(t(r),{label:"URL前缀",path:"local_prefix"},{default:i(()=>[l(t(g),{value:a.value.local_prefix,"onUpdate:value":e[3]||(e[3]=s=>a.value.local_prefix=s),type:"text",placeholder:"图片访问的URL前缀，默认为程序运行地址",clearable:""},null,8,["value"])]),_:1}),l(t(D),{type:"info",style:{"margin-bottom":"16px"}},{default:i(()=>e[17]||(e[17]=[d(" 本地存储模式下，图片将保存到项目根目录下的指定文件夹中，并按时间自动组织URL结构。URL前缀用于组成完整的图片访问链接。 ")])),_:1}),l(t(L),null,{default:i(()=>e[18]||(e[18]=[d("备份功能")])),_:1}),l(t(h),{vertical:""},{default:i(()=>[l(t(r),{label:"备份相册"},{default:i(()=>[l(t(h),null,{default:i(()=>[l(t(N),{type:"primary",loading:_.value,onClick:I},{default:i(()=>e[19]||(e[19]=[d(" 备份相册 ")])),_:1},8,["loading"]),e[20]||(e[20]=v("span",{class:"text-gray-500"},"检测并打包下载本地上传的所有图片",-1))]),_:1})]),_:1}),l(t(r),{label:"备份数据库"},{default:i(()=>[l(t(h),null,{default:i(()=>[l(t(N),{type:"primary",loading:y.value,onClick:E},{default:i(()=>e[21]||(e[21]=[d(" 备份数据库 ")])),_:1},8,["loading"]),e[22]||(e[22]=v("span",{class:"text-gray-500"},"下载本地数据库文件（仅限本地存储模式）",-1))]),_:1})]),_:1})]),_:1}),l(t(D),{type:"warning",style:{"margin-top":"16px"}},{default:i(()=>e[23]||(e[23]=[v("strong",null,"备份说明：",-1),v("br",null,null,-1),d(" • 备份相册：将检测设置的默认上传路径下的图片，提供打包下载"),v("br",null,null,-1),d(" • 备份数据库：下载的是本地数据库文件，包含所有相册数据和设置信息"),v("br",null,null,-1),d(" • 建议定期备份以防数据丢失 ")])),_:1})],64)):(U(),B(C,{key:1},[l(t(r),{label:o.$t("views.setting.label_max_size"),path:"max_size"},{default:i(()=>[l(t(O),{value:a.value.max_size,"onUpdate:value":e[4]||(e[4]=s=>a.value.max_size=s),precision:2,disabled:!a.value.enable_storage,placeholder:o.$t("views.setting.placeholder_max_size"),"w-500":""},{suffix:i(()=>e[24]||(e[24]=[d(" MB ")])),_:1},8,["value","disabled","placeholder"])]),_:1},8,["label"]),l(t(r),{label:o.$t("views.setting.label_timeout_time"),path:"timeout_time"},{default:i(()=>[l(t(O),{value:a.value.timeout_time,"onUpdate:value":e[5]||(e[5]=s=>a.value.timeout_time=s),precision:0,disabled:!a.value.enable_storage,placeholder:o.$t("views.setting.placeholder_timeout_time"),"w-500":""},{suffix:i(()=>e[25]||(e[25]=[d(" 秒 ")])),_:1},8,["value","disabled","placeholder"])]),_:1},8,["label"]),l(t(r),{label:o.$t("views.setting.label_endpoint"),path:"endpoint"},{default:i(()=>[l(t(g),{value:a.value.endpoint,"onUpdate:value":e[6]||(e[6]=s=>a.value.endpoint=s),type:"text",placeholder:o.$t("views.setting.placeholder_endpoint"),disabled:!a.value.enable_storage,clearable:""},null,8,["value","placeholder","disabled"])]),_:1},8,["label"]),l(t(r),{label:o.$t("views.setting.label_region"),path:"region"},{default:i(()=>[l(t(g),{value:a.value.region,"onUpdate:value":e[7]||(e[7]=s=>a.value.region=s),type:"text",placeholder:o.$t("views.setting.placeholder_region"),disabled:!a.value.enable_storage,clearable:""},null,8,["value","placeholder","disabled"])]),_:1},8,["label"]),l(t(r),{label:o.$t("views.setting.label_access_id"),path:"access_id"},{default:i(()=>[l(t(g),{value:a.value.access_id,"onUpdate:value":e[8]||(e[8]=s=>a.value.access_id=s),type:"text",placeholder:o.$t("views.setting.placeholder_access_id"),disabled:!a.value.enable_storage,clearable:""},null,8,["value","placeholder","disabled"])]),_:1},8,["label"]),l(t(r),{label:o.$t("views.setting.label_secret_key"),path:"secret_key"},{default:i(()=>[l(t(g),{value:a.value.secret_key,"onUpdate:value":e[9]||(e[9]=s=>a.value.secret_key=s),type:"text",placeholder:o.$t("views.setting.placeholder_secret_key"),disabled:!a.value.enable_storage,clearable:""},null,8,["value","placeholder","disabled"])]),_:1},8,["label"]),l(t(r),{label:o.$t("views.setting.label_bucket"),path:"bucket"},{default:i(()=>[l(t(g),{value:a.value.bucket,"onUpdate:value":e[10]||(e[10]=s=>a.value.bucket=s),type:"text",placeholder:o.$t("views.setting.placeholder_bucket"),disabled:!a.value.enable_storage,clearable:""},null,8,["value","placeholder","disabled"])]),_:1},8,["label"]),l(t(r),{label:o.$t("views.setting.label_path"),path:"path"},{default:i(()=>[l(t(g),{value:a.value.path,"onUpdate:value":e[11]||(e[11]=s=>a.value.path=s),type:"text",placeholder:o.$t("views.setting.placeholder_path",{path:"{year}/{month}/{timestamp}_{filename}"}),disabled:!a.value.enable_storage,clearable:""},null,8,["value","placeholder","disabled"])]),_:1},8,["label"]),l(t(r),{label:o.$t("views.setting.label_prefix"),path:"prefix"},{default:i(()=>[l(t(g),{value:a.value.prefix,"onUpdate:value":e[12]||(e[12]=s=>a.value.prefix=s),type:"text",placeholder:o.$t("views.setting.placeholder_prefix"),disabled:!a.value.enable_storage,clearable:""},null,8,["value","placeholder","disabled"])]),_:1},8,["label"]),l(t(r),{label:o.$t("views.setting.label_suffix"),path:"suffix"},{default:i(()=>[l(t(g),{value:a.value.suffix,"onUpdate:value":e[13]||(e[13]=s=>a.value.suffix=s),type:"text",placeholder:o.$t("views.setting.placeholder_suffix"),disabled:!a.value.enable_storage,clearable:""},null,8,["value","placeholder","disabled"])]),_:1},8,["label"])],64)),l(t(L)),l(t(N),{type:"primary",loading:b.value,onClick:e[14]||(e[14]=s=>x(!0))},{default:i(()=>[d(X(o.$t("common.buttons.save")),1)]),_:1},8,["loading"])]),_:1},8,["model"])])]),_:1},8,["title"]))}};export{fe as default};
